<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Todo App</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Load Fun Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- 3. Configure Tailwind with new fonts -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              // 'Gochi Hand' for headers
              display: ['"Gochi Hand"', 'cursive'],
              // 'Kalam' for body text
              body: ['Kalam', 'cursive'],
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(-10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              fadeOut: {
                '0%': { opacity: '1', transform: 'scale(1)' },
                '100%': { opacity: '0', transform: 'scale(0.9)' },
              }
            },
            animation: {
              fadeIn: 'fadeIn 0.3s ease-out',
              fadeOut: 'fadeOut 0.3s ease-in forwards',
            }
          }
        }
      }
    </script>

    <!-- 4. Custom Styles for the page -->
    <style>
      /* Use the 'body' font by default */
      body {
        font-family: 'Kalam', 'cursive';
        /* A nice, soft "paper" color */
        background-color: #fdfaf6; 
      }
      /* Custom scrollbar for task lists (kept from original) */
      .task-list::-webkit-scrollbar {
        width: 6px;
      }
      .task-list::-webkit-scrollbar-thumb {
        background-color: #9ca3af; /* gray-400 */
        border-radius: 3px;
      }
      .task-list::-webkit-scrollbar-track {
        background-color: #e5e7eb; /* gray-200 */
      }
    </style>
</head>
<body class="flex items-start justify-center min-h-screen p-4 md:p-8">

    <!-- Main Application Card - Styled like a piece of paper -->
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-2xl p-6 md:p-8 transform -rotate-1 hover:rotate-0 transition-transform duration-200">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <h1 class="font-display text-5xl md:text-6xl font-bold text-gray-800">My Todo List</h1>
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden">
                <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>

        <!-- Add New Task Form - Styled to look like writing on a line -->
        <form id="task-form" class="flex items-center space-x-3 mb-8">
            <input type="text" id="task-input" placeholder="What needs to be done?" class="flex-1 w-full text-xl md:text-2xl font-body bg-transparent border-0 border-b-2 border-gray-300 focus:ring-0 focus:outline-none focus:border-blue-500 transition" required>
            <button type="submit" class="px-6 py-3 font-display text-xl text-white bg-blue-500 rounded-full shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transform hover:scale-105 transition">
                Add
            </button>
        </form>

        <!-- Pending Tasks Section -->
        <div class="mb-8">
            <h2 class="font-display text-3xl font-semibold text-gray-700 mb-4">Pending</h2>
            <ul id="pending-tasks-list" class="space-y-2 task-list max-h-60 overflow-y-auto pr-2">
                <!-- Tasks will be dynamically inserted here -->
                <li id="pending-placeholder" class="text-gray-400 italic text-lg">No pending tasks... time to relax!</li>
            </ul>
        </div>

        <!-- Completed Tasks Section -->
        <div>
            <h2 class="font-display text-3xl font-semibold text-gray-700 mb-4">Completed</h2>
            <ul id="completed-tasks-list" class="space-y-2 task-list max-h-60 overflow-y-auto pr-2">
                <!-- Completed tasks will be dynamically inserted here -->
                <li id="completed-placeholder" class="text-gray-400 italic text-lg">Nothing completed yet.</li>
            </ul>
        </div>

        <!-- Error Message Bar -->
        <div id="error-message" class="hidden mt-6 p-4 text-sm font-body text-red-700 bg-red-100 rounded-lg" role="alert">
            <span class="font-medium">Oops!</span> <span id="error-text"></span>
        </div>

    </div>

    <!-- JavaScript Application -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIG ---
            // const API_URL = 'http://127.0.0.1:5000/todos';
            const API_URL = 'http://flask-todo-api-env.eba-mk6kjtps.ap-south-1.elasticbeanstalk.com/todos';

            // --- DOM Elements ---
            const taskForm = document.getElementById('task-form');
            const taskInput = document.getElementById('task-input');
            const pendingList = document.getElementById('pending-tasks-list');
            const completedList = document.getElementById('completed-tasks-list');
            const loadingIndicator = document.getElementById('loading-indicator');
            const pendingPlaceholder = document.getElementById('pending-placeholder');
            const completedPlaceholder = document.getElementById('completed-placeholder');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');

            // --- UI Helper Functions ---
            const showLoading = () => loadingIndicator.classList.remove('hidden');
            const hideLoading = () => loadingIndicator.classList.add('hidden');

            const showError = (message) => {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                setTimeout(() => {
                    errorMessage.classList.add('hidden');
                }, 5000);
            };

            const updatePlaceholders = () => {
                pendingPlaceholder.classList.toggle('hidden', pendingList.children.length > 1);
                completedPlaceholder.classList.toggle('hidden', completedList.children.length > 1);
            };

            /**
             * Creates a new task list item element
             * @param {object} task - The task object from the API
             */
            const createTaskElement = (task) => {
                const li = document.createElement('li');
                li.dataset.id = task.id;
                // Styled to look like text on a dotted line
                li.className = `
                    flex items-center py-3 border-b border-dotted border-gray-300
                    transition-all duration-300
                    animate-fadeIn
                `;

                const isChecked = task.completed;

                li.innerHTML = `
                    <input 
                        type="checkbox" 
                        ${isChecked ? 'checked' : ''}
                        class="task-checkbox h-6 w-6 ${isChecked ? 'text-gray-400' : 'text-blue-500'} rounded border-gray-300 focus:ring-blue-400 cursor-pointer"
                    >
                    <span class="task-text flex-1 mx-4 text-xl ${isChecked ? 'line-through text-gray-400 decoration-red-500 decoration-2' : 'text-gray-800'} transition-all duration-300">
                        ${task.task}
                    </span>
                    <button class="delete-btn p-1 text-gray-400 hover:text-red-500 transition-colors duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                `;

                // Add event listeners to the new element
                li.querySelector('.task-checkbox').addEventListener('change', (e) => handleToggleTask(e, task.id));
                li.querySelector('.delete-btn').addEventListener('click', () => handleDeleteTask(task.id));

                return li;
            };

            /**
             * Renders all tasks into the correct lists
             * @param {Array} tasks - An array of task objects
             */
            const renderTasks = (tasks) => {
                // Clear lists (but keep placeholders)
                while (pendingList.children.length > 1) pendingList.removeChild(pendingList.lastChild);
                while (completedList.children.length > 1) completedList.removeChild(completedList.lastChild);

                tasks.forEach(task => {
                    const taskElement = createTaskElement(task);
                    if (task.completed) {
                        completedList.appendChild(taskElement);
                    } else {
                        pendingList.appendChild(taskElement);
                    }
                });
                updatePlaceholders();
            };

            // --- API Call Functions (CRUD) ---

            /**
             * (READ) Fetches all tasks from the API and renders them
             */
            async function loadTasks() {
                showLoading();
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error('Failed to fetch tasks.');
                    const tasks = await response.json();
                    renderTasks(tasks);
                } catch (err) {
                    showError(err.message || 'Could not connect to API.');
                } finally {
                    hideLoading();
                }
            }

            /**
             * (CREATE) Handles the submission of the new task form
             */
            async function handleAddTask(e) {
                e.preventDefault();
                const taskText = taskInput.value.trim();
                if (!taskText) return;

                const submitButton = taskForm.querySelector('button');
                submitButton.disabled = true;
                submitButton.textContent = '...';

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task: taskText }),
                    });

                    if (!response.ok) throw new Error('Failed to add task.');
                    
                    const newTask = await response.json();
                    const taskElement = createTaskElement(newTask);
                    pendingList.appendChild(taskElement);
                    
                    taskInput.value = '';
                    updatePlaceholders();

                } catch (err) {
                    showError(err.message);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Add';
                }
            }

            /**
             * (UPDATE) Toggles a task's completed status
             */
            async function handleToggleTask(e, id) {
                const isChecked = e.target.checked;
                const li = e.target.closest('li');
                const taskText = li.querySelector('.task-text').textContent.trim();

                // Optimistic UI Update (start animation)
                li.style.animation = 'fadeOut 0.3s ease-in forwards';
                
                try {
                    const response = await fetch(`${API_URL}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            task: taskText, // Send original task text
                            completed: isChecked 
                        }),
                    });
                    
                    if (!response.ok) throw new Error('Failed to update task.');

                    // Wait for fade-out animation to finish, then move element
                    li.addEventListener('animationend', () => {
                        if (isChecked) {
                            completedList.appendChild(li);
                        } else {
                            pendingList.appendChild(li);
                        }
                        // Update styles and fade back in
                        li.querySelector('.task-text').classList.toggle('line-through', isChecked);
                        li.querySelector('.task-text').classList.toggle('text-gray-400', isChecked);
                        li.querySelector('.task-text').classList.toggle('decoration-red-500', isChecked);
                        li.querySelector('.task-text').classList.toggle('decoration-2', isChecked);
                        li.querySelector('.task-checkbox').classList.toggle('text-gray-400', isChecked);
                        li.querySelector('.task-checkbox').classList.toggle('text-blue-500', !isChecked);
                        li.style.animation = 'fadeIn 0.3s ease-out';
                        updatePlaceholders();
                    }, { once: true });

                } catch (err) {
                    showError(err.message);
                    // Rollback UI on failure
                    e.target.checked = !isChecked; // Un-toggle the checkbox
                    li.style.animation = ''; // Stop animation
                }
            }

            /**
             * (DELETE) Deletes a task from the server
             */
            async function handleDeleteTask(id) {
                const li = document.querySelector(`li[data-id="${id}"]`);
                if (!li) return;

                // Optimistic UI: Animate out
                li.style.animation = 'fadeOut 0.3s ease-in forwards';

                try {
                    const response = await fetch(`${API_URL}/${id}`, {
                        method: 'DELETE',
                    });

                    if (!response.ok) throw new Error('Failed to delete task.');

                    // Wait for animation to finish, then remove
                    li.addEventListener('animationend', () => {
                        li.remove();
                        updatePlaceholders();
                    });

                } catch (err) {
                    showError(err.message);
                    // Rollback UI on failure
                    li.style.animation = '';
                }
            }

            // --- Initialization ---
            taskForm.addEventListener('submit', handleAddTask);
            loadTasks();
            updatePlaceholders(); // Initial check for placeholders
        });
    </script>
</body>
</html>